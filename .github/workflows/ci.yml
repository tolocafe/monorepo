name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: read
    outputs:
      app: ${{ steps.filter.outputs.app }}
      workers: ${{ steps.filter.outputs.workers }}
      website: ${{ steps.filter.outputs.website }}
      studio: ${{ steps.filter.outputs.studio }}
      poster-plugin: ${{ steps.filter.outputs.poster-plugin }}
      packages: ${{ steps.filter.outputs.packages }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'apps/app/**'
            workers:
              - 'apps/workers/**'
            website:
              - 'apps/website/**'
            studio:
              - 'apps/studio/**'
            poster-plugin:
              - 'apps/poster-plugin/**'
            packages:
              - 'packages/**'
            any:
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.js'
              - '**/*.jsx'
              - '**/*.json'
              - 'bun.lock'

  quality-app:
    name: Quality App
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.app == 'true' || needs.changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/app

      - name: Check formatting
        run: bun run --filter @tolo/app format:check

      - name: Lint
        run: bun run --filter @tolo/app lint

      - name: Typecheck
        run: bun run --filter @tolo/app typecheck

  test-app:
    name: Test App
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality-app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/app

      - name: Run tests
        run: bun run --filter @tolo/app test

  quality-workers:
    name: Quality Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.workers == 'true' || needs.changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/workers

      - name: Check formatting
        run: bun run --filter @tolo/workers format:check

      - name: Lint
        run: bun run --filter @tolo/workers lint

      - name: Typecheck
        run: bun run --filter @tolo/workers typecheck

  test-workers:
    name: Test Workers
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality-workers
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/workers

      - name: Run tests
        run: bun run --filter @tolo/workers test

  quality-website:
    name: Quality Website
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.website == 'true' || needs.changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/website

      - name: Check formatting
        run: bun run --filter @tolo/website format:check

      - name: Lint
        run: bun run --filter @tolo/website lint

      - name: Typecheck
        run: bun run --filter @tolo/website typecheck

  build-website:
    name: Build Website
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality-website
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/website

      - name: Build
        run: bun run --filter @tolo/website build

  quality-studio:
    name: Quality Studio
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.studio == 'true' || needs.changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/studio

      - name: Check formatting
        run: bun run --filter @tolo/studio format:check

      - name: Lint
        run: bun run --filter @tolo/studio lint

      - name: Typecheck
        run: bun run --filter @tolo/studio typecheck

  build-studio:
    name: Build Studio
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality-studio
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/studio

      - name: Build
        run: bun run --filter @tolo/studio build

  quality-poster-plugin:
    name: Quality Poster Plugin
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.poster-plugin == 'true' || needs.changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/poster-plugin

      - name: Check formatting
        run: bun run --filter @tolo/poster-plugin format:check

      - name: Lint
        run: bun run --filter @tolo/poster-plugin lint

      - name: Typecheck
        run: bun run --filter @tolo/poster-plugin typecheck

  build-poster-plugin:
    name: Build Poster Plugin
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality-poster-plugin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter @tolo/poster-plugin

      - name: Build
        run: bun run --filter @tolo/poster-plugin build
